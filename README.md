# Gmail to BAND 連携システム

## 概要
このシステムは、特定の送信元から届いた Gmail（防犯メール、鉄道運行情報など）を解析し、指定した BAND 掲示板へ自動投稿する Google Apps Script（GAS）です。
さらに、特定の住所（西鎌倉・腰越・深沢・片瀬地区など）が含まれる重要な防犯情報は、別の BAND（自治会用など）へも自動的に転送・マルチポストします。

## 主な機能
1. **Gmail 自動解析投稿**
   - 送信元に応じたタグ付け（例：`#防犯`）やルールの適用。
   - 不要な定型文（フッターの解除案内など）の自動カット。
2. **条件付きマルチポスト（特定住所検知）**
   - ピーガルくん安全メールの中に、設定した住所リストが含まれる場合のみ、転送先 BAND にも投稿します。
3. **添付ファイル対応**
   - メールの添付ファイルを Google ドライブへ保存し、その共有 URL を BAND 投稿に含めます。
4. **定期天気予報投稿**
   - 指定した地点（西鎌倉周辺）の 3 時間ごとの天気予報を毎日定時に投稿します。
5. **エラー通知**
   - API 制限や設定ミスで投稿に失敗した際、管理者に詳細なエラー通知メールを送信します。

## ファイル構成
- `Main.gs`: メインロジック。トリガー用の関数やメール解析処理を記述。
- `Config.gs`: 全ての設定（トークン、BAND キー、住所リスト、フィルタ条件）を管理。
- `BandHelper.gs`: BAND API との通信、および Google ドライブへのファイル保存を担当。
- `Weather.gs`: Open-Meteo API を利用した天気予報の取得と整形。
- `Announce.gs`: 管理者へのエラー通知メール送信処理。
- `Tool.gs`: 自分の所属する BAND の `band_key` を取得するための補助ツール。

## セットアップ

### 1. Config.gs の設定
`Config.gs` を開き、以下の項目を設定してください。

- **接続情報**
  - `BAND_ACCESS_TOKEN`: BAND Developers で取得したトークン。
  - `TARGET_BAND_KEY`: メインの投稿先 BAND。
  - `EXTRA_BAND_KEY`: 特定住所検知時の転送先 BAND。
  - `IMAGE_FOLDER_ID`: 添付ファイルを保存する Google ドライブのフォルダ ID。
- **転送判定設定 (`EXTRA_POST_CONFIG`)**
  - `WATCH_ADDRESSES`: 転送対象とする住所キーワードのリスト。

### 2. トリガーの設定
GAS エディタの「トリガー（時計アイコン）」から、以下の 2 つを設定します。

| 実行する関数 | イベントのソース | 時間の間隔 | 備考 |
| :--- | :--- | :--- | :--- |
| `triggerGmailToBand` | 時間主導型 | 10分〜15分おき | メールの監視と投稿（`checkGmailAndPostToBand` を実行） |
| `triggerWeather` | 時間主導型 | 特定の時間 | 毎朝の天気予報投稿など |

## 運用上の注意
- **投稿権限**: 使用するアクセストークンのアカウントが、メイン・転送先両方の BAND で「投稿権限」を持っている必要があります。
- **ロック機構**: `LockService` を導入しているため、処理が重なっても二重投稿されない安全設計です。
